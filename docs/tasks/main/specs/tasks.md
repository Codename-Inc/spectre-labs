# Tasks — Planning Pipeline (`--plan`)

*Generated by create_tasks on 2026-02-09*

## Objective

Add a `--plan` flag to `spectre-build` that runs a multi-stage autonomous planning pipeline, transforming scope documents into a build-ready manifest.

## Scope

- **In Scope**: `--plan` CLI flag, 7-stage pipeline (research/assess/create_plan/create_tasks/plan_review/req_validate/update_docs), complexity-aware routing, autonomous prompt templates, planning hooks, session pause/resume for clarifications, manifest output, stats tracking
- **Out of Scope**: Auto-continue into build loop, custom pipeline YAML, web GUI, changes to main Spectre repo prompts

## Requirements Traced

| ID | Description | Source | Tasks |
|----|-------------|--------|-------|
| REQ-001 | `--plan` CLI flag routing | scope | 4.1 |
| REQ-002 | 7-stage planning pipeline | plan | 1.1, 1.2 |
| REQ-003 | Complexity-aware routing (LIGHT skips create_plan) | scope | 1.1 |
| REQ-004 | `create_plan_pipeline()` factory | plan | 1.1 |
| REQ-005 | `create_plan_resume_pipeline()` factory | plan | 1.2 |
| REQ-006 | 7 autonomous prompt templates | plan | 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7 |
| REQ-007 | Planning-specific hooks | plan | 3.1 |
| REQ-008 | Session extension for planning state | plan | 4.2 |
| REQ-009 | Resume flow with update_docs pipeline | plan | 4.3 |
| REQ-010 | Manifest output with YAML frontmatter | scope | 2.6, 2.7 |
| REQ-011 | Stats tracking for planning stages | scope | 3.2 |
| REQ-012 | Research stage WebSearch/WebFetch access | clarification | 1.1 |
| REQ-013 | CLARIFICATIONS_NEEDED CLI-level exit | clarification | 4.1 |
| REQ-014 | Notifications on completion | scope | 4.1 |

---

## Architecture Context

### Where This Fits

- Extends the `spectre-build` CLI with a new execution mode (`--plan`) alongside existing `--validate` and `--pipeline` modes
- Reuses the pipeline engine (`executor.py`, `stage.py`, `completion.py`) with zero changes to those modules
- Adds a new pipeline factory in `loader.py` following the `create_default_pipeline()` pattern
- Adds planning-specific hooks in `hooks.py` following the `before_stage_hook`/`after_stage_hook` pattern

### Technical Approach

- Factory function `create_plan_pipeline()` constructs 7-stage `PipelineConfig` with `JsonCompletion` on all stages
- Assess stage emits `LIGHT`/`STANDARD`/`COMPREHENSIVE` signals; transitions conditionally skip `create_plan`
- CLI-level exit handles `CLARIFICATIONS_NEEDED` (no executor changes)
- Separate `create_plan_resume_pipeline()` for post-clarification resume (single `update_docs` stage)
- Each prompt is an autonomous adaptation of existing `/spectre:*` interactive prompts

### Key Decisions

- All stages use `JsonCompletion` with `signal_field="status"` for consistency
- Resume uses a separate single-stage pipeline config (avoids modifying executor for arbitrary start stages)
- Research stage gets `WebSearch`/`WebFetch` access; all other stages use build loop restrictions
- Assess stage includes architecture design for COMPREHENSIVE (no separate stage)

---

## Tasks

### Phase 1: Pipeline Infrastructure

#### [x] [1.1] Create planning pipeline factory
- [x] **1.1.1** Add `create_plan_pipeline()` function to `pipeline/loader.py`
  - **Produces**: `PipelineConfig` with 7 stages (research, assess, create_plan, create_tasks, plan_review, req_validate, update_docs)
  - **Consumed by**: `run_plan_pipeline()` in `cli.py`
  - **Replaces**: N/A (new)
  - [x] Returns `PipelineConfig` with `start_stage="research"` and `end_signals=["PLAN_VALIDATED", "PLAN_READY"]`
  - [x] Assess stage transitions: `LIGHT→create_tasks`, `STANDARD→create_plan`, `COMPREHENSIVE→create_plan`
  - [x] All stages use `JsonCompletion` with stage-specific complete statuses

- [x] **1.1.2** Configure research stage with expanded tool access
  - **Produces**: `StageConfig` for research stage with `denied_tools` excluding WebSearch/WebFetch
  - **Consumed by**: `create_plan_pipeline()` stage definitions
  - **Replaces**: N/A (new)
  - [x] Research stage `denied_tools` omits `WebSearch` and `WebFetch` (allowed for research only)
  - [x] All other stages use standard build loop denied tools list

- [x] **1.1.3** Wire prompt template paths for all 7 stages
  - **Produces**: Absolute paths to `prompts/planning/*.md` templates in each `StageConfig`
  - **Consumed by**: `Stage.load_template()` during execution
  - **Replaces**: N/A (new)
  - [x] Resolves paths relative to `prompts/planning/` directory using `Path(__file__).parent.parent / "prompts" / "planning"` pattern
  - [x] Each stage references its corresponding template file

#### [x] [1.2] Create planning resume pipeline factory
- [x] **1.2.1** Add `create_plan_resume_pipeline()` function to `pipeline/loader.py`
  - **Produces**: `PipelineConfig` with single `update_docs` stage
  - **Consumed by**: `run_plan_pipeline()` in `cli.py` (resume path)
  - **Replaces**: N/A (new)
  - [x] Single stage: `update_docs` with `JsonCompletion(complete_statuses=["PLAN_READY"])`
  - [x] `start_stage="update_docs"`, `end_signals=["PLAN_READY"]`

### Phase 2: Prompt Templates

#### [x] [2.1] Create research stage prompt
- [x] **2.1.1** Write `prompts/planning/research.md` template
  - **Produces**: `task_context.md` file in `{output_dir}` with codebase research findings
  - **Consumed by**: Assess stage reads `task_context.md`
  - **Replaces**: Research steps from interactive `/spectre:create_plan` Step 1
  - [x] Instructs agent to read scope docs from `{context_files}`, explore codebase with Read/Grep/Glob
  - [x] Writes findings to `{output_dir}/task_context.md` with architecture patterns, dependencies, integration points
  - [x] Emits JSON with `"status": "RESEARCH_COMPLETE"` and `"task_context_path"` artifact

#### [x] [2.2] Create assess stage prompt
- [x] **2.2.1** Write `prompts/planning/assess.md` template
  - **Produces**: Complexity tier signal (`LIGHT`/`STANDARD`/`COMPREHENSIVE`) and updated `task_context.md`
  - **Consumed by**: Pipeline transitions route to `create_plan` or `create_tasks` based on signal
  - **Replaces**: Complexity assessment from interactive `/spectre:plan` Step 3
  - [x] Reads `{task_context_path}` and scope docs, scores complexity (files impacted, pattern match, components crossed, data model changes, integration points)
  - [x] Checks hard-stops (new service, auth/PII change, public API change, etc.)
  - [x] For COMPREHENSIVE: includes architecture design section in `task_context.md`
  - [x] Emits JSON with `"status"` as tier signal plus `"depth"` and `"tier"` artifact fields

#### [x] [2.3] Create plan generation prompt
- [x] **2.3.1** Write `prompts/planning/create_plan.md` template
  - **Produces**: `plan.md` file in `{output_dir}/specs/`
  - **Consumed by**: Create tasks stage and plan review stage read `plan.md`
  - **Replaces**: Plan generation from interactive `/spectre:create_plan` Step 3
  - [x] Reads `{task_context_path}` and scope docs, uses `{depth}` to determine section depth (standard vs comprehensive)
  - [x] Writes plan to `{output_dir}/specs/plan.md` with Overview, Technical Approach, Critical Files
  - [x] Emits JSON with `"status": "PLAN_COMPLETE"` and `"plan_path"` artifact

#### [x] [2.4] Create task breakdown prompt
- [x] **2.4.1** Write `prompts/planning/create_tasks.md` template
  - **Produces**: `tasks.md` file in `{output_dir}/specs/`
  - **Consumed by**: Plan review stage and req_validate stage read `tasks.md`
  - **Replaces**: Task breakdown from interactive `/spectre:create_tasks`
  - [x] Reads `{plan_path}` (if exists — may not for LIGHT), `{task_context_path}`, and scope docs
  - [x] Generates hierarchical task breakdown (Phase → Parent → Sub-task → Acceptance Criteria)
  - [x] Emits JSON with `"status": "TASKS_COMPLETE"` and `"tasks_path"` artifact

#### [x] [2.5] Create plan review prompt
- [x] **2.5.1** Write `prompts/planning/plan_review.md` template
  - **Produces**: Updated `plan.md` and `tasks.md` with simplifications applied
  - **Consumed by**: Req_validate stage reads simplified plan and tasks
  - **Replaces**: Adapted from interactive `/spectre:plan_review`
  - [x] Reads `{plan_path}` and `{tasks_path}`, identifies over-engineering and unnecessary abstractions
  - [x] Edits files in-place to apply simplifications (removes complexity, not requirements)
  - [x] Emits JSON with `"status": "REVIEW_COMPLETE"` and summary of changes made

#### [x] [2.6] Create requirements validation prompt
- [x] **2.6.1** Write `prompts/planning/req_validate.md` template
  - **Produces**: Either `build.md` manifest (if validated) or `scope_clarifications.md` (if gaps)
  - **Consumed by**: CLI parses signal to determine exit or pause behavior
  - **Replaces**: N/A (new validation concept for planning)
  - [x] Cross-references scope docs against `{plan_path}` and `{tasks_path}` for coverage gaps
  - [x] If all requirements addressed: writes manifest to `{output_dir}/build.md` with YAML frontmatter, emits `"status": "PLAN_VALIDATED"` with `"manifest_path"` artifact
  - [x] If gaps found: writes clarification questions to `{output_dir}/clarifications/scope_clarifications_{timestamp}.md` with `<response></response>` blocks, emits `"status": "CLARIFICATIONS_NEEDED"` with `"clarifications_path"` artifact

#### [x] [2.7] Create update_docs prompt (resume stage)
- [x] **2.7.1** Write `prompts/planning/update_docs.md` template
  - **Produces**: Updated scope/plan/tasks docs plus `build.md` manifest
  - **Consumed by**: CLI reads manifest path from artifacts to print final command
  - **Replaces**: N/A (new resume-specific stage)
  - [x] Reads `{clarification_answers}` (injected by hook from clarifications file)
  - [x] Updates scope docs, plan.md, and tasks.md based on clarification answers
  - [x] Writes manifest to `{output_dir}/build.md` with YAML frontmatter
  - [x] Emits JSON with `"status": "PLAN_READY"` and `"manifest_path"` artifact

### Phase 3: Hooks and Stats

#### [x] [3.1] Add planning-specific lifecycle hooks
- [x] **3.1.1** Implement `plan_before_stage()` in `hooks.py`
  - **Produces**: Context dict mutations (depth defaults, clarification content injection)
  - **Consumed by**: `PipelineExecutor` calls this before each planning stage
  - **Replaces**: N/A (new, alongside existing `before_stage_hook`)
  - [x] For `create_plan` stage: ensures `depth` is in context (defaults to `"standard"`)
  - [x] For `update_docs` stage: reads clarifications file from `clarifications_path` and injects content as `clarification_answers`

- [x] **3.1.2** Implement `plan_after_stage()` in `hooks.py`
  - **Produces**: Context dict enrichment from stage artifacts
  - **Consumed by**: `PipelineExecutor` calls this after each planning stage
  - **Replaces**: N/A (new, alongside existing `after_stage_hook`)
  - [x] For `assess` stage: ensures `depth` and `tier` from artifacts flow into context
  - [x] For `req_validate` stage with `CLARIFICATIONS_NEEDED`: stores clarifications path in context for session save

#### [x] [3.2] Add planning loop counters to stats
- [x] **3.2.1** Add `plan_loops` field to `BuildStats` and wire `on_event` callback
  - **Produces**: `plan_loops` counter incremented per planning stage completion
  - **Consumed by**: `stats.print_summary()` dashboard display
  - **Replaces**: N/A (extends existing stats)
  - [x] Add `plan_loops: int = 0` to `BuildStats` dataclass
  - [x] Wire `on_event` callback in `run_plan_pipeline()` that increments `plan_loops` on `StageCompletedEvent`
  - [x] Dashboard shows `PLAN LOOPS: N` line in summary

### Phase 4: CLI Integration

#### [4.1] Add `--plan` flag and `run_plan_pipeline()` to CLI
- [ ] **4.1.1** Add `--plan` argument to `parse_args()` in `cli.py`
  - **Produces**: `args.plan` boolean flag
  - **Consumed by**: `main()` routing logic
  - **Replaces**: N/A (new flag)
  - [ ] Added as `store_true` action, help text describes planning pipeline
  - [ ] `--plan` makes `--tasks` optional (tasks are generated)

- [ ] **4.1.2** Implement `run_plan_pipeline()` function in `cli.py`
  - **Produces**: `tuple[int, int]` (exit_code, total_iterations)
  - **Consumed by**: `main()` and `run_resume()` routing
  - **Replaces**: N/A (new function alongside `run_default_pipeline`)
  - [ ] Creates output directory (`docs/tasks/{branch_name}` or user-specified)
  - [ ] Builds initial context dict with `context_files`, `output_dir`, paths
  - [ ] Calls `create_plan_pipeline()` or `create_plan_resume_pipeline()` based on `resume_stage` param
  - [ ] Wires `plan_before_stage`/`plan_after_stage` hooks and `on_event` callback
  - [ ] Handles `CLARIFICATIONS_NEEDED` signal: saves session, prints message, returns exit code 0
  - [ ] On `PLAN_VALIDATED` / `PLAN_READY`: prints manifest path and `spectre-build` command

- [ ] **4.1.3** Wire `--plan` routing in `main()` function
  - **Produces**: Correct routing from `main()` to `run_plan_pipeline()`
  - **Consumed by**: Entry point execution flow
  - **Replaces**: N/A (extends existing routing)
  - [ ] `--plan` takes priority: `if args.plan → run_plan_pipeline()`
  - [ ] `--plan` without `--context` prints error and exits
  - [ ] Sends notification on completion/error

#### [4.2] Extend session persistence for planning
- [ ] **4.2.1** Update `save_session()` and `load_session()` for planning state
  - **Produces**: Session JSON with `plan`, `plan_output_dir`, `plan_context`, `plan_clarifications_path` fields
  - **Consumed by**: `run_resume()` reads these to route to planning resume
  - **Replaces**: N/A (extends existing session schema)
  - [ ] `save_session()` accepts new keyword args: `plan`, `plan_output_dir`, `plan_context`, `plan_clarifications_path`
  - [ ] Session JSON includes all planning-specific fields when `plan=True`

- [ ] **4.2.2** Update `format_session_summary()` for planning display
  - **Produces**: Human-readable session summary showing planning state
  - **Consumed by**: `run_resume()` displays this before confirmation
  - **Replaces**: N/A (extends existing format)
  - [ ] Shows "Mode: Planning" and stage info
  - [ ] Shows clarifications path if paused for clarifications

#### [4.3] Wire planning resume flow
- [ ] **4.3.1** Update `run_resume()` to handle planning sessions
  - **Produces**: Correct routing from resume to `run_plan_pipeline()` with resume params
  - **Consumed by**: `spectre-build resume` command
  - **Replaces**: N/A (extends existing resume routing)
  - [ ] Detects `plan=True` in session, routes to `run_plan_pipeline()` with `resume_stage="update_docs"`
  - [ ] Passes preserved `plan_context` from session as initial context
  - [ ] Shows planning-specific confirmation message mentioning clarifications file

---

## Execution Strategies

### Sequential Execution

1. 1.1 - Create planning pipeline factory (no dependencies)
2. 1.2 - Create planning resume pipeline factory (no dependencies)
3. 2.1 - Research prompt (depends on 1.1 for template path wiring)
4. 2.2 - Assess prompt (depends on 1.1)
5. 2.3 - Create plan prompt (depends on 1.1)
6. 2.4 - Create tasks prompt (depends on 1.1)
7. 2.5 - Plan review prompt (depends on 1.1)
8. 2.6 - Req validate prompt (depends on 1.1)
9. 2.7 - Update docs prompt (depends on 1.2)
10. 3.1 - Planning hooks (depends on 1.1, 1.2)
11. 3.2 - Stats tracking (no dependencies)
12. 4.1 - CLI flag + run_plan_pipeline (depends on 1.1, 1.2, 3.1, 3.2)
13. 4.2 - Session persistence (depends on 4.1)
14. 4.3 - Resume flow (depends on 4.1, 4.2)

### Parallel Execution

**Wave 1 (concurrent)**: 1.1, 1.2, 3.2
- Rationale: Pipeline factories and stats field are independent; no shared files

**Wave 2 (after Wave 1)**: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 3.1
- Rationale: All prompts depend on factory for path resolution; hooks depend on both factories. Prompts are independent of each other.

**Wave 3 (after Wave 2)**: 4.1
- Rationale: CLI integration depends on factories, hooks, and stats being in place

**Wave 4 (after Wave 3)**: 4.2, 4.3
- Rationale: Session and resume depend on `run_plan_pipeline()` existing

---

## Coverage Summary

- Total Requirements Extracted: 14
- Requirements with Task Coverage: 14 (100%)
- Phases: 4
- Parent Tasks: 9
- Sub-tasks: 16
