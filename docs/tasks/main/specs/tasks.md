# Tasks — Ship Loop (`--ship`)

*Generated by create_tasks on 2026-02-18*

## Objective
Add a `--ship` flag to `spectre-build` that runs a 3-stage autonomous pipeline (clean → test → rebase) to take a feature branch from "works on branch" to "landed on main" without human babysitting.

## Scope
- **In Scope**: `--ship` CLI flag with flag/interactive/manifest modes, 3-stage pipeline (clean/test/rebase), session persistence + resume, stats tracking, notifications, prompt templates, inter-stage hooks, parent branch detection
- **Out of Scope**: `--build --ship` chaining, stage skipping flags, running git/gh from Python, standalone CLI command, new completion strategies, PipelineExecutor changes, custom ship YAML definitions, ship-specific code review stage

## Requirements Traced

| ID | Description | Source | Tasks |
|----|-------------|--------|-------|
| REQ-001 | `--ship` flag as `store_true` argument in `parse_args()` | plan.md, scope.md | 1.1 |
| REQ-002 | `--ship` routing in `main()` after `--plan` but before `--validate` | plan.md, scope.md | 1.1 |
| REQ-003 | `run_ship_pipeline()` function modeled on `run_plan_pipeline()` | plan.md | 1.2 |
| REQ-004 | Parent branch detection with fail-fast error on failure | plan.md, scope.md | 1.2 |
| REQ-005 | Working set scope computation (`{parent_branch}..HEAD`) | plan.md | 1.2 |
| REQ-006 | Interactive mode with `"ship"` option in `prompt_for_mode()` | plan.md, scope.md | 1.3 |
| REQ-007 | `create_ship_pipeline()` factory returning 3-stage PipelineConfig | plan.md, scope.md | 2.1 |
| REQ-008 | Clean stage: `JsonCompletion`, `CLEAN_TASK_COMPLETE`/`CLEAN_COMPLETE` signals, max 10 iterations | plan.md, scope.md | 2.1 |
| REQ-009 | Test stage: `JsonCompletion`, `TEST_TASK_COMPLETE`/`TEST_COMPLETE` signals, max 10 iterations | plan.md, scope.md | 2.1 |
| REQ-010 | Rebase stage: `JsonCompletion`, `SHIP_COMPLETE` signal, max 3 iterations | plan.md, scope.md | 2.1 |
| REQ-011 | `ship_before_stage()` and `ship_after_stage()` hooks | plan.md, scope.md | 2.2 |
| REQ-012 | HEAD snapshot before clean and test stages, diff capture after | plan.md | 2.2 |
| REQ-013 | `clean_summary` and `test_summary` injected into context by after-hooks | plan.md, scope.md | 2.2 |
| REQ-014 | Clean prompt template with 7-task checklist, `{parent_branch}` and `{working_set_scope}` variables | plan.md, scope.md | 3.1 |
| REQ-015 | Test prompt template with 4-task checklist, `{working_set_scope}` variable | plan.md, scope.md | 3.2 |
| REQ-016 | Rebase prompt template (single context window), `{parent_branch}`, `{clean_summary}`, `{test_summary}` variables | plan.md, scope.md | 3.3 |
| REQ-017 | PR creation via `gh pr create` with template detection, or local merge with stash approval | plan.md, scope.md | 3.3 |
| REQ-018 | Session persistence: `ship` and `ship_context` fields in `save_session()` with backward compat | plan.md, scope.md | 4.1 |
| REQ-019 | Resume routing: `elif session.get("ship"):` in `run_resume()` | plan.md, scope.md | 4.1 |
| REQ-020 | `format_session_summary()` shows "Mode: Ship" and parent branch | plan.md | 4.1 |
| REQ-021 | `ship: bool = False` field in `BuildManifest`, parsed from frontmatter | plan.md, scope.md | 4.2 |
| REQ-022 | Manifest routing: `manifest.ship` routes to `run_ship_pipeline()` in `run_manifest()` | plan.md | 4.2 |
| REQ-023 | `ship_loops: int = 0` field in `BuildStats` | plan.md, scope.md | 4.3 |
| REQ-024 | `create_ship_event_handler()` factory for stats | plan.md | 4.3 |
| REQ-025 | `print_summary()` displays ship loop count when > 0 | plan.md | 4.3 |
| REQ-026 | `notify_ship_complete()` function with audio | plan.md, scope.md | 4.4 |
| REQ-027 | Notification called from all ship entry points (main, resume, manifest) | plan.md | 4.4 |
| REQ-028 | Same denied tools as build loop for all 3 ship stages | plan.md, scope.md | 2.1 |
| REQ-029 | Context files optional for ship (not required like `--plan`) | plan.md, scope.md | 1.1, 1.3 |
| REQ-030 | No changes to PipelineExecutor, stage.py, completion.py, stream.py, or agent.py | scope.md | all |

---

## Architecture Context

### Where This Fits
- Ship is the third autonomous pipeline in `spectre-build`, alongside build (`--validate`) and plan (`--plan`)
- It extends `cli.py` routing, `loader.py` factories, `hooks.py` lifecycle callbacks, and `stats.py`/`notify.py` support modules
- It reuses `PipelineExecutor` (`pipeline/executor.py`), `JsonCompletion` (`pipeline/completion.py`), `Stage` (`pipeline/stage.py`), and `git_scope.py` without modification

### Technical Approach
- Follow the exact pattern established by `--plan`: factory function in `loader.py`, hooks in `hooks.py`, orchestration function in `cli.py`, stats handler in `stats.py`, notification in `notify.py`
- Three new prompt templates in `prompts/shipping/` directory (paralleling `prompts/planning/`)
- All ship-specific behavior lives in new code; no core engine changes

### Key Decisions
- Reuse `PipelineExecutor` as-is — zero changes to the core engine (scope constraint)
- Parent branch detection happens in `run_ship_pipeline()` before pipeline creation — fail fast
- Rebase stage is a single context window (max 3 iterations) because conflict resolution needs continuous state
- Agent handles all git/gh commands via prompts — Python orchestrates, agent acts
- `--ship` does not require `--tasks` — generates work from codebase state

---

## Tasks

### Phase 1: CLI Routing and Orchestration

#### [1.1] Add `--ship` Flag and Main Routing
- [ ] **1.1.1** Add `--ship` as a `store_true` argument in `parse_args()` in `cli.py`, placed near `--plan` and `--validate`
  - **Produces**: `args.ship` boolean flag available on parsed args
  - **Consumed by**: `main()` routing block, `run_manifest()`, interactive mode
  - **Replaces**: N/A (new flag)
  - [ ] `--ship` appears in `spectre-build --help` with description
  - [ ] `args.ship` is `False` by default when flag is not provided

- [ ] **1.1.2** Add `--ship` routing block in `main()` after the `--plan` block but before `--validate`, following the same pattern: check flag → resolve optional context files → detect parent branch → save session → call `run_ship_pipeline()` → notify → sys.exit
  - **Produces**: Execution path from CLI args to `run_ship_pipeline()`
  - **Consumed by**: End users invoking `spectre-build --ship`
  - **Replaces**: N/A (new routing path)
  - [ ] `--ship` block executes when flag is set, skipping `--validate` and legacy paths
  - [ ] Context files are resolved if provided via `--context` but are not required (no error without them)
  - [ ] `notify_ship_complete()` is called after `run_ship_pipeline()` returns

#### [1.2] Implement `run_ship_pipeline()` Function
- [x] **1.2.1** Create `run_ship_pipeline()` function in `cli.py` with signature `(context_files, max_iterations, agent, resume_context) -> tuple[int, int]`, modeled on `run_plan_pipeline()`. Implements: parent branch detection (via `git merge-base` / `git log` heuristics, fail fast on failure), working set scope computation (`{parent_branch}..HEAD`), context dict assembly (keys: `parent_branch`, `working_set_scope`, `context_files`, `clean_summary`, `test_summary`), pipeline wiring (`create_ship_pipeline()`, `PipelineExecutor` with ship hooks and `create_ship_event_handler()`), and execution
  - **Produces**: `run_ship_pipeline()` callable returning `(exit_code, total_iterations)`
  - **Consumed by**: `main()` routing (1.1.2), `run_resume()` (4.1), `run_manifest()` (4.2)
  - **Replaces**: N/A (new function)
  - [x] Parent branch detected and stored in context before pipeline creation; clear error on failure
  - [x] Working set scope computed as commit range from parent branch
  - [x] Context dict includes all required keys with correct initial values
  - [x] `PipelineExecutor` wired with `ship_before_stage`, `ship_after_stage`, and `create_ship_event_handler`
  - [x] Returns `tuple[int, int]` (exit_code, total_iterations)

#### [1.3] Add Ship to Interactive Mode
- [ ] **1.3.1** Add `"ship"` option to `prompt_for_mode()` in `cli.py`. When selected, prompt for optional context files, confirm detected parent branch, and call `run_ship_pipeline()`
  - **Produces**: Interactive ship entry point
  - **Consumed by**: Users invoking `spectre-build` with no flags
  - **Replaces**: N/A (new option in existing menu)
  - [ ] `"ship"` appears as a selectable option in interactive mode
  - [ ] Interactive flow prompts for optional context files (not required)
  - [ ] Detected parent branch is displayed for user confirmation before proceeding

### Phase 2: Pipeline Infrastructure

#### [2.1] Create Ship Pipeline Factory
- [x] **2.1.1** Add `create_ship_pipeline()` function in `loader.py` returning a `PipelineConfig` with name `"ship"`, `start_stage="clean"`, `end_signals=["SHIP_COMPLETE"]`, and 3 `StageConfig` objects. Reuse existing denied tools list (`PLAN_DENIED_TOOLS`) for all stages. Stage configs:
  - **Clean**: `JsonCompletion(complete_statuses=["CLEAN_TASK_COMPLETE", "CLEAN_COMPLETE"], signal_field="status")`, `max_iterations=10`, transitions `{"CLEAN_TASK_COMPLETE": "clean", "CLEAN_COMPLETE": "test"}`, prompt `prompts/shipping/clean.md`
  - **Test**: `JsonCompletion(complete_statuses=["TEST_TASK_COMPLETE", "TEST_COMPLETE"], signal_field="status")`, `max_iterations=10`, transitions `{"TEST_TASK_COMPLETE": "test", "TEST_COMPLETE": "rebase"}`, prompt `prompts/shipping/test.md`
  - **Rebase**: `JsonCompletion(complete_statuses=["SHIP_COMPLETE"], signal_field="status")`, `max_iterations=3`, empty transitions `{}`, prompt `prompts/shipping/rebase.md`
  - **Produces**: `create_ship_pipeline()` factory function returning `PipelineConfig`
  - **Consumed by**: `run_ship_pipeline()` in `cli.py` (1.2.1)
  - **Replaces**: N/A (new factory alongside `create_plan_pipeline()`)
  - [x] Returns `PipelineConfig` with `name="ship"`, `start_stage="clean"`, `end_signals=["SHIP_COMPLETE"]`
  - [x] Contains exactly 3 stages (clean, test, rebase) with correct completion strategies and transitions
  - [x] Rebase stage max_iterations is 3 (single context window)
  - [x] Denied tools reuse existing list (blocks AskUserQuestion, WebFetch, WebSearch, Task, EnterPlanMode, NotebookEdit)

#### [2.2] Implement Ship Hooks
- [x] **2.2.1** Add `ship_before_stage()` function in `hooks.py` following the same signature as `plan_before_stage()`. For `"clean"` and `"test"`: snapshot HEAD via `snapshot_head()` from `git_scope.py`
  - **Produces**: `ship_before_stage()` callback function
  - **Consumed by**: `PipelineExecutor` via `before_stage` parameter (1.2.1)
  - **Replaces**: N/A
  - [x] Snapshots HEAD into context before clean and test stages
  - [x] No special before-hook logic for rebase stage

- [x] **2.2.2** Add `ship_after_stage()` function in `hooks.py` following the same signature as `plan_after_stage()`. For `"clean"`: collect git diff since snapshot, store as `context["clean_summary"]`. For `"test"`: collect git diff since snapshot, store as `context["test_summary"]`
  - **Produces**: `ship_after_stage()` callback function
  - **Consumed by**: `PipelineExecutor` via `after_stage` parameter (1.2.1)
  - **Replaces**: N/A
  - [x] After clean stage: `context["clean_summary"]` contains files removed and commits made
  - [x] After test stage: `context["test_summary"]` contains tests added and coverage changes
  - [x] No special after-hook logic for rebase stage

### Phase 3: Prompt Templates

#### [3.1] Create Clean Stage Prompt
- [x] **3.1.1** Create `prompts/shipping/clean.md` with a 7-task checklist: (1) determine working set scope, (2) analyze dead code, (3) analyze duplication, (4) dispatch investigation subagents, (5) validate findings, (6) execute removals + verify + commit, (7) ESLint compliance. Uses `{parent_branch}` and `{working_set_scope}` context variables. Each task emits `{"status": "CLEAN_TASK_COMPLETE"}`, final task emits `{"status": "CLEAN_COMPLETE"}`
  - **Produces**: Clean stage prompt template file
  - **Consumed by**: `Stage.build_prompt()` during clean stage execution (2.1.1)
  - **Replaces**: N/A (new file)
  - [x] Template contains 7 numbered tasks matching the scope's clean checklist
  - [x] Uses `{parent_branch}` and `{working_set_scope}` placeholder variables
  - [x] Includes clear STOP instructions between tasks and JSON completion block format

#### [3.2] Create Test Stage Prompt
- [x] **3.2.1** Create `prompts/shipping/test.md` with a 4-task checklist: (1) discover working set + plan, (2) risk assessment + test plan (P0-P3 tiers), (3) write tests + verify, (4) commit. Uses `{working_set_scope}` and optional `{context_files}` variables. Each task emits `{"status": "TEST_TASK_COMPLETE"}`, final task emits `{"status": "TEST_COMPLETE"}`
  - **Produces**: Test stage prompt template file
  - **Consumed by**: `Stage.build_prompt()` during test stage execution (2.1.1)
  - **Replaces**: N/A (new file)
  - [x] Template contains 4 numbered tasks matching the scope's test checklist
  - [x] Uses `{working_set_scope}` and `{context_files}` placeholder variables
  - [x] Includes clear STOP instructions between tasks and JSON completion block format

#### [3.3] Create Rebase Stage Prompt
- [x] **3.3.1** Create `prompts/shipping/rebase.md` as a single context window (not decomposed into tasks). Uses `{parent_branch}`, `{clean_summary}`, `{test_summary}` context variables. Covers: confirm target branch, prepare (commit uncommitted, fetch, create safety ref), execute rebase, resolve conflicts, verify (lint + tests pass), land via PR (`gh pr create` with template detection) or local merge (stash approval via `read -p` in Bash), summary. Emits `{"status": "SHIP_COMPLETE"}`
  - **Produces**: Rebase stage prompt template file
  - **Consumed by**: `Stage.build_prompt()` during rebase stage execution (2.1.1)
  - **Replaces**: N/A (new file)
  - [x] Template uses `{parent_branch}`, `{clean_summary}`, `{test_summary}` placeholder variables
  - [x] Includes PR creation logic with `gh auth status` check and PR template detection
  - [x] Includes local merge fallback with stash approval flow using `read -p` via Bash

### Phase 4: Integration and Support Modules

#### [4.1] Session Persistence and Resume
- [x] **4.1.1** Add `ship: bool = False` and `ship_context: dict | None = None` parameters to `save_session()` in `cli.py` with defaults for backward compatibility. Store both in the session JSON
  - **Produces**: Ship fields in session JSON
  - **Consumed by**: `run_resume()` for ship resume detection (4.1.2), `format_session_summary()` (4.1.3)
  - **Replaces**: N/A (extends existing function)
  - [x] New parameters have defaults — existing callers are unaffected
  - [x] `load_session()` retrieves ship fields via `.get()` with defaults (already safe pattern)

- [x] **4.1.2** Add `elif session.get("ship"):` block in `run_resume()` after the `if session.get("plan"):` block. Call `run_ship_pipeline()` with `resume_context=session.get("ship_context")`
  - **Produces**: Resume routing for interrupted ship sessions
  - **Consumed by**: Users invoking `spectre-build resume` after a ship interruption
  - **Replaces**: N/A (new elif branch)
  - [x] Ship sessions detected by `session.get("ship") == True`
  - [x] `run_ship_pipeline()` called with resume context from session, followed by notification

- [x] **4.1.3** Update `format_session_summary()` to show "Mode: Ship" when `session.get("ship")` is true, and display `parent_branch` from `ship_context`
  - **Produces**: Human-readable ship session display
  - **Consumed by**: Resume confirmation prompt shown to user
  - **Replaces**: N/A (extends existing function)
  - [x] Summary shows "Mode: Ship" for ship sessions
  - [x] Parent branch is displayed from ship context

#### [4.2] Manifest Support
- [x] **4.2.1** Add `ship: bool = False` field to `BuildManifest` dataclass in `manifest.py`. Update `load_manifest()` to parse `ship` from YAML frontmatter
  - **Produces**: `manifest.ship` boolean field
  - **Consumed by**: `run_manifest()` routing check (4.2.2)
  - **Replaces**: N/A (extends existing dataclass)
  - [x] `BuildManifest` has `ship` field with `False` default
  - [x] `load_manifest()` reads `ship` from frontmatter (same pattern as `validate`)

- [x] **4.2.2** Add `manifest.ship` routing check in `run_manifest()` in `cli.py`, before the `validate` check. Route to `run_ship_pipeline()` when `manifest.ship` is true
  - **Produces**: Manifest-driven ship pipeline execution path
  - **Consumed by**: Users invoking `spectre-build ship.md`
  - **Replaces**: N/A (new routing branch)
  - [x] Ship check occurs before validate check in `run_manifest()`
  - [x] Routes to `run_ship_pipeline()` with manifest's context files and settings

#### [4.3] Stats Tracking
- [x] **4.3.1** Add `ship_loops: int = 0` field to `BuildStats` dataclass in `stats.py`
  - **Produces**: `ship_loops` counter on `BuildStats`
  - **Consumed by**: `create_ship_event_handler()` (4.3.2), `print_summary()` (4.3.3)
  - **Replaces**: N/A (extends existing dataclass)
  - [x] `ship_loops` field exists with default value 0
  - [x] Does not affect existing stats fields or behavior

- [x] **4.3.2** Add `create_ship_event_handler(stats)` factory function in `stats.py` following `create_plan_event_handler()` pattern. Returns callback that increments `stats.ship_loops` on `StageCompletedEvent`
  - **Produces**: Event handler callback for ship pipeline
  - **Consumed by**: `PipelineExecutor` via `on_event` parameter in `run_ship_pipeline()` (1.2.1)
  - **Replaces**: N/A (new factory function)
  - [x] Returns callable that increments `ship_loops` on each `StageCompletedEvent`
  - [x] Follows same pattern as `create_plan_event_handler()`

- [x] **4.3.3** Update `print_summary()` in `stats.py` to display ship loop count when `ship_loops > 0`, following the plan loops display pattern
  - **Produces**: Ship loop count in dashboard output
  - **Consumed by**: End-of-pipeline summary display
  - **Replaces**: N/A (extends existing dashboard)
  - [x] Ship loop count displayed when > 0
  - [x] Follows same formatting pattern as plan loops display

#### [4.4] Notification
- [x] **4.4.1** Add `notify_ship_complete()` function to `notify.py` following `notify_plan_complete()` pattern. Message: `"Ship complete! {stages} stages in {time}"` (success) / `"Ship failed after {stages} stages ({time})"` (failure). Includes branch detection and audio. Wiring at call sites (main, resume, manifest) is handled by tasks 1.1.2, 4.1.2, and 4.2.2
  - **Produces**: `notify_ship_complete()` callable
  - **Consumed by**: `main()` ship block (1.1.2), `run_resume()` ship block (4.1.2), `run_manifest()` ship block (4.2.2)
  - **Replaces**: N/A (new notification function)
  - [x] Function follows same signature pattern as `notify_plan_complete()`
  - [x] Includes success and failure messaging with audio notification

---

## Execution Strategies

### Sequential Execution
1. 4.3 - Stats Tracking (no dependencies — extends `BuildStats` dataclass)
2. 4.4 - Notification (no dependencies — extends `notify.py`)
3. 4.1 - Session Persistence and Resume (no dependencies — extends `save_session()` and `run_resume()`)
4. 4.2 - Manifest Support (no dependencies — extends `BuildManifest` and `run_manifest()`)
5. 2.1 - Create Ship Pipeline Factory (no dependencies — new function in `loader.py`)
6. 2.2 - Implement Ship Hooks (depends on 2.1 for understanding context variable names)
7. 3.1 - Create Clean Stage Prompt (depends on 2.1 for signal names and 2.2 for context variables)
8. 3.2 - Create Test Stage Prompt (depends on 2.1 for signal names and 2.2 for context variables)
9. 3.3 - Create Rebase Stage Prompt (depends on 2.1 for signal names and 2.2 for context variables)
10. 1.2 - Implement `run_ship_pipeline()` (depends on 2.1, 2.2, 4.3, 4.4 — wires pipeline, hooks, stats, notify)
11. 1.1 - Add `--ship` Flag and Main Routing (depends on 1.2 — calls `run_ship_pipeline()`)
12. 1.3 - Add Ship to Interactive Mode (depends on 1.2 — calls `run_ship_pipeline()`)

### Parallel Execution

**Wave 1 (concurrent)**: 4.3, 4.4, 4.1, 4.2, 2.1
- Rationale: These are all independent additions to separate files — `stats.py`, `notify.py`, `cli.py` session functions, `manifest.py`, and `loader.py`. No shared state or file conflicts.

**Wave 2 (after Wave 1)**: 2.2, 3.1, 3.2, 3.3
- Rationale: Hooks (2.2) need to know context variable names from the pipeline factory (2.1). Prompt templates (3.1-3.3) need signal names from 2.1 and context variable names from 2.2. However, 2.2 and prompts can be developed concurrently since the variable names are already documented in the plan.

**Wave 3 (after Wave 2)**: 1.2
- Rationale: `run_ship_pipeline()` is the main orchestration function that wires together the pipeline factory (2.1), hooks (2.2), stats handler (4.3), and notification (4.4). All must exist before this function can be implemented.

**Wave 4 (after Wave 3)**: 1.1, 1.3
- Rationale: Both the flag routing (1.1) and interactive mode (1.3) call `run_ship_pipeline()` which must be implemented first. These two can run concurrently since they modify different sections of `cli.py`.

---

## Coverage Summary
- Total Requirements Extracted: 30
- Requirements with Task Coverage: 30 (100%)
- Phases: 4
- Parent Tasks: 10
- Sub-tasks: 14
